{% extends 'administrator/main.html' %}
{% load i18n %}
{% load custom_filters %}  {# get_language_text filtrini yuklash #}

{% block vendor_css %}

    <style>
        .hover-btn-primary:hover {
            background-color: #0d6efd;
            color: white !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link.active {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
            background-color: #f8f9fa;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            border-bottom: 2px solid #6c757d;
            color: #6c757d;
        }
    </style>
{% endblock vendor_css %}


{% block content %}
    <div class="app-body mt-4">
            <div class="card shadow border-0 rounded-3">
                <div class="card-header   p-3 d-flex justify-content-between align-items-center rounded-top">
                    <h2 class="mb-0 fw-bold">{% trans "Yangilik tafsilotlari" %}</h2>
                    <a href="{% url 'news-view' %}"
                       class="btn btn-primary text-white fw-semibold px-3 py-2 rounded-3 shadow-sm hover-btn-secondary">
                        {% trans "Ortga" %}
                    </a>
                </div>

                <div class="card-body p-4">
                    <!-- üîÄ Tillarni o‚Äòz ichiga olgan tabs (yorliqlar) -->
                    <ul class="nav nav-tabs mb-4 border-bottom" id="lang-tabs" role="tablist">
                        {% for lang_code, lang_name in LANGUAGES %}
                            <li class="nav-item" role="presentation">
                                <a class="nav-link {% if forloop.first %}active{% endif %}"
                                   id="tab-{{ lang_code }}"
                                   data-bs-toggle="tab"
                                   href="#lang-{{ lang_code }}"
                                   role="tab"
                                   aria-controls="lang-{{ lang_code }}"
                                   aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                    {{ lang_name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>

                    <!-- üìú Har bir til uchun alohida ma‚Äôlumotlar -->
                    <div class="tab-content" id="lang-tab-content">
                        {% for lang_code, lang_name in LANGUAGES %}
                            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                                 id="lang-{{ lang_code }}"
                                 role="tabpanel"
                                 aria-labelledby="tab-{{ lang_code }}">
                                <form class="news-form" data-lang="{{ lang_code }}" method="POST"
                                      enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                                    <!-- üìù Sarlavha -->
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">
                                            {% trans "Sarlavha" %} ({{ lang_name }})
                                        </label>
                                        <input type="text" name="title_{{ lang_code }}"
                                               class="form-control border rounded-3 shadow-sm py-2 px-3"
                                               value="{{ news.title|get_language_text:lang_code }}"
                                               placeholder="{% trans 'Sarlavha kiriting...' %}">
                                    </div>

                                    <!-- üìú Matn -->
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">
                                            {% trans "Matn" %} ({{ lang_name }})
                                        </label>
                                        <textarea name="content_{{ lang_code }}"
                                                  class="form-control border rounded-3 shadow-sm py-2 px-3"
                                                  rows="6"
                                                  placeholder="{% trans 'Matn kiriting...' %}">{{ news.content|get_language_text:lang_code }}</textarea>
                                    </div>

                                    <!-- üì∑ Rasm -->
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">
                                            {% trans "Rasm" %} ({{ lang_name }})
                                        </label>
                                        <input type="file" name="image"
                                               class="form-control border rounded-3 shadow-sm py-2">
                                        {% if news.image %}
                                            <div class="mt-3">
                                                <img src="{{ news.image.url }}"
                                                     class="img-fluid rounded-3 shadow-sm"
                                                     style="max-height: 300px; width: 100%; object-fit: cover;"
                                                     alt="{% trans 'Yangilik rasmi' %}">
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- üíæ Saqlash tugmasi -->
                                    <button type="button"
                                            class="btn btn-primary fw-semibold px-4 py-2 rounded-3 shadow-sm hover-btn-primary save-news"
                                            data-lang="{{ lang_code }}">
                                        {% trans "Saqlash" %}
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
    </div>
{% endblock content %}

{% block vendor_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- ‚úÖ SweetAlert kutubxonasi -->

    <script>
        $(document).ready(function () {
            $(".save-news").click(function () {
                var news_id = "{{ news.id }}"; // üîπ Yangilik ID'ni olish
                var formData = new FormData(); // üîπ FormData obyektini yaratish

                // üîπ CSRF tokenni olish
                var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
                formData.append("csrfmiddlewaretoken", csrf_token); // üîπ CSRF token qo'shish
                formData.append("news_id", news_id); // üîπ Yangilik ID'ni qo'shish

                // üåç Barcha tillardagi formani olish
                $(".news-form").each(function () {
                    var lang = $(this).data("lang"); // üîπ Til kodini olish
                    var form = $(this)[0]; // üîπ Formni olish

                    // üìå Har bir input maydonini qo‚Äòshish
                    $(form).find("input[type='text'], textarea").each(function () {
                        formData.append($(this).attr("name"), $(this).val());
                    });

                    // üì∏ Rasm fayllarini qo'shish
                    var imageInput = $(form).find("input[type='file']")[0];
                    if (imageInput.files.length > 0) {
                        formData.append(imageInput.name, imageInput.files[0]);
                    }
                });

                console.log("üì§ Yuborilayotgan ma'lumotlar:", Object.fromEntries(formData.entries())); // ‚úÖ Debug uchun

                // üì° AJAX so‚Äòrovni yuborish
                $.ajax({
                    url: "{% url 'news-detail' %}", // üîó Django view'ga so‚Äòrov yuborish
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        Swal.fire({
                            icon: 'success',
                            title: "‚úÖ Muvaffaqiyat!",
                            text: response.message,
                            confirmButtonText: "OK"
                        }).then(() => {
                            location.reload(); // üîÑ Sahifani yangilash
                        });
                    },
                    error: function (xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: "‚ùå Xatolik!",
                            text: xhr.responseText,
                            confirmButtonText: "Yopish"
                        });
                    }
                });
            });
        });
    </script>




{% endblock vendor_js %}
