{% extends 'dashboard.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}
    Yangiliklar
{% endblock title %}
{% block style %}
{% endblock style %}

<style>
    #load-more-btn .right-icon {
        display: none; /* 🔥 Boshlang‘ichda ikonani yashiramiz */
    }
</style>
{% block content %}


    <div class="dz-bnr-inr dz-banner-dark overlay-secondary-middle dz-bnr-inr-md"
         style="background-image:url({% static 'dashboard/images/banner/bnr2.webp' %});">
        <div class="container">
            <div class="dz-bnr-inr-entry d-table-cell">
                <h1 class="wow fadeInUp" data-wow-delay="0.2s" data-wow-duration="0.8s">Yangiliklar</h1>
                <nav aria-label="breadcrumb" class="breadcrumb-row wow fadeInUp" data-wow-delay="0.4s"
                     data-wow-duration="0.8s">
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'main-dashboard' %}">Asosiy sahifa</a></li>
                        <li class="breadcrumb-item">Yangiliklar</li>
                    </ul>
                </nav>
                <div class="dz-btn">
                    <a href="tel: {{ site_settings.contact_phone }}"
                       class="btn btn-lg btn-icon btn-primary radius-xl btn-shadow mb-3 mb-sm-0">
						<span class="left-icon">
							<i class="feather icon-phone-call"></i>
						</span>
                        {{ site_settings.contact_phone }}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <section class="content-inner">
        <div class="container">
            <div class="row">
                <div class="col-xl-9 col-lg-12 m-b30 pe-xl-5">
                    <div class="loadmore-content">
                        <!-- 📌 AJAX orqali yangiliklar shu yerga qo‘shiladi -->
                    </div>
                    <div class="text-center m-t30 m-lg-t0 wow fadeInUp" data-wow-delay="0.7s" data-wow-duration="0.5s">
                        <button id="load-more-btn" class="btn btn-lg btn-icon btn-primary dz-load-more">
                            Ko'proq yuklash
                            <span class="right-icon"><i class="feather icon-refresh-ccw"></i></span>
                        </button>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-12">
                    <aside class="side-bar sticky-top right m-b30 p-0">
                        <div class="widget wow fadeInUp" data-wow-delay="0.1s" data-wow-duration="0.5s">
                            <div class="widget-title">
                                <h4 class="title">Qidirish</h4>
                            </div>
                            <div class="search-bx">
                                <form role="search" method="post">
                                    <div class="input-group">
                                        <input name="search_text" class="form-control" placeholder="Qidirish"
                                               type="text">
                                        <div class="input-group-btn">
                                            <button type="submit" id="search-btn">
                                                <i class="feather icon-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="widget widget_categories style-1 wow fadeInUp" data-wow-delay="0.2s"
                             data-wow-duration="0.5s">
                            <div class="widget-title">
                                <h4 class="title">Oy boyicha qidirish</h4>
                            </div>
                            <ul>
                                {% for entry in monthly_news_data %}
                                    <li class="cat-item">
                                        <a href="?month={{ entry.month_number }}">{{ entry.month }}</a>
                                        ({{ entry.count }})
                                    </li>
                                {% empty %}
                                    <li class="cat-item">Hozircha yangiliklar mavjud emas</li>
                                {% endfor %}
                            </ul>

                        </div>
                        <div class="widget recent-posts-entry wow fadeInUp" data-wow-delay="0.3s"
                             data-wow-duration="0.5s">
                            <div class="widget-title">
                                <h4 class="title">Oxirgi yangiliklar</h4>
                            </div>
                            <div class="widget-post-bx">
                                {% for news in latest_news %}
                                    <div class="widget-post clearfix">
                                        <div class="dz-media">
                                            <img src="{{ news.image.url }}"
                                                 alt="{{ news.title|get_language_text:CURRENT_LANGUAGE }}">
                                        </div>
                                        <div class="dz-info">
                                            <div class="dz-meta">
                                                <ul>
                                                    <li class="post-date">
                                                        <a href="javascript:void(0);">
                                                            {{ news.published_date|date:"d F Y" }}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            <h6 class="title">
                                                <a href="">
                                                    {{ news.title|get_language_text:CURRENT_LANGUAGE }}
                                                </a>
                                            </h6>
                                        </div>
                                    </div>
                                {% empty %}
                                    <p>Oxirgi yangiliklar mavjud emas</p>
                                {% endfor %}

                            </div>
                        </div>

                    </aside>
                </div>
            </div>
        </div>
    </section>
{% endblock content %}



{% block script %}


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // CSRF tokenni olish funksiyasi
        function getCSRFToken() {
            return document.querySelector("[name=csrfmiddlewaretoken]").value;
        }

        // AJAX so‘rovlarini CSRF bilan yuborish
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
                }
            }
        });

    </script>
    <script>


        $(document).ready(function () {
            let page = 1;
            let loadedNewsIds = new Set();
            let isLoading = false;

            // 🌍 Joriy tilni aniqlash
            function getCurrentLang() {
                return document.documentElement.lang || "uz"; // Standart til: o‘zbekcha
            }

            // 🌍 JSON formatidagi matndan joriy til bo‘yicha ma’lumot olish
            function getLocalizedText(data) {
                let lang = getCurrentLang();
                if (typeof data === "string") {
                    try {
                        data = JSON.parse(data);
                    } catch (error) {
                        return data; // JSON bo‘lmasa, o‘zini qaytarish
                    }
                }
                return data[lang] || data["uz"] || "Tavsif mavjud emas"; // 🔄 Til bo‘yicha mos matnni chiqarish
            }

            // 📌 Yangiliklarni yuklash funksiyasi
            function loadNews(page = 1, search = "", month = "") {
                if (isLoading) return;
                isLoading = true;

                $("#load-more-btn .right-icon").show(); // 🔄 Yuklanayotganini ko‘rsatish

                $.ajax({
                    url: `/api/news/?page=${page}&search=${encodeURIComponent(search)}&month=${month}`,
                    method: "GET",
                    success: function (data) {
                        if (data?.results?.length) {
                            if (page === 1) $(".loadmore-content").html(""); // 🔄 Eski ma’lumotni tozalash

                            data.results.forEach(news => {
                                if (!loadedNewsIds.has(news.id)) {
                                    loadedNewsIds.add(news.id);
                                    let newsHtml = `
                                <div class="dz-card style-2 blog-half m-b35">
                                    <div class="dz-media">
                                        <img src="${news.image || '/static/dashboard/images/blog/grid/default-image.webp'}"
                                             alt="${getLocalizedText(news.title)}">
                                    </div>
                                    <div class="dz-info">
                                        <div class="dz-meta">
                                            <ul>
                                                <li class="post-date">
                                                    ${new Date(news.published_date).toLocaleDateString(getCurrentLang(), {
                                        year: 'numeric', month: 'long', day: 'numeric'
                                    })}
                                                </li>
                                                <li class="post-author">By <a href="#">${news.author_name || 'ClinicMaster'}</a></li>
                                                <li class="post-comments">0 COMMENTS</li>
                                            </ul>
                                        </div>
                                        <h3 class="dz-title">
                                            <a href="#">${getLocalizedText(news.title)}</a>
                                        </h3>
                                        <p>${getLocalizedText(news.content).substring(0, 100)}...</p>

                                            <!-- Read More tugmasi -->
                                            <a href="" class="btn icon-link-hover-end btn-primary radius-sm">
                                                Koproq <i class="feather icon-arrow-right"></i>
                                            </a>
                                    </div>

                                </div>
                            `;
                                    $(".loadmore-content").append(newsHtml);
                                }
                            });

                            page++; // 📌 Keyingi sahifaga o‘tish
                            $("#load-more-btn").show();
                        } else {
                            $("#load-more-btn").hide();
                        }
                    },
                    complete: function () {
                        isLoading = false;
                        $("#load-more-btn .right-icon").hide();
                    }
                });
            }

            // 🔎 Qidirish funksiyasi
            $(".search-bx form").on("submit", function (e) {
                e.preventDefault();
                let searchText = $(this).find("input[name='search_text']").val().trim();
                page = 1;
                loadedNewsIds.clear();
                loadNews(page, searchText, "");
            });

            // 📅 Oyni tanlash (Filter)
            $(".widget_categories ul li a").on("click", function () {
                let monthName = $(this).text().trim();
                let monthMap = {
                    "Yanvar": "1",
                    "Fevral": "2",
                    "Mart": "3",
                    "Aprel": "4",
                    "May": "5",
                    "Iyun": "6",
                    "Iyul": "7",
                    "Avgust": "8",
                    "Sentabr": "9",
                    "Oktabr": "10",
                    "Noyabr": "11",
                    "Dekabr": "12"
                };

                let monthNumber = monthMap[monthName] || "";
                loadNews(1, "", monthNumber);
            });

            // 📌 "Ko‘proq yuklash" tugmasi
            $("#load-more-btn").on("click", function () {
                let searchText = $(".search-bx input[name='text']").val();
                let selectedMonth = $(".widget_categories ul li a.active").text().trim();
                let monthNumber = monthMap[selectedMonth] || "";

                loadNews(page, searchText, monthNumber);
            });

            // 🔄 Boshlang‘ich yuklash
            loadNews();
        });

    </script>





{% endblock script %}